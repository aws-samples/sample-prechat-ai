AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Deployment stage
  BedrockRegion:
    Type: String
    Default: ap-northeast-2
    Description: AWS Region for Bedrock services
    AllowedValues:
      - us-east-1
      - us-west-2
      - ap-northeast-1
      - ap-northeast-2
      - eu-west-1
      - eu-central-1
  BedrockAgentAliasId:
    Type: String
    Default: TSTALIASID
    Description: AgentCore Agent Alias ID to use for invocations
  AllowedEmailDomains:
    Type: String
    Default: amazon.com,your-email-domain.com
    Description: Comma-separated list of allowed email domains for user registration
  LambdaConcurrencyLimit:
    Type: Number
    Default: 10
    Description: Reserved concurrency limit for Lambda functions
    MinValue: 1
    MaxValue: 1000

Globals:
  Function:
    Runtime: python3.13
    Timeout: 30
    ReservedConcurrentExecutions: !Ref LambdaConcurrencyLimit
    Layers:
      - !Ref SharedLayer
    DeadLetterQueue:
      Type: SQS
      TargetArn: !GetAtt LambdaDeadLetterQueue.Arn
    VpcConfig:
      SecurityGroupIds:
        - !Ref LambdaSecurityGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Environment:
      Variables:
        SESSIONS_TABLE: !Ref SessionsTable
        MESSAGES_TABLE: !Ref MessagesTable
        CAMPAIGNS_TABLE: !Ref CampaignsTable
        BEDROCK_REGION: !Ref BedrockRegion
        USER_POOL_ID: !Ref AdminUserPool
        CLIENT_ID: !Ref AdminUserPoolClient
        ALLOWED_EMAIL_DOMAINS: !Ref AllowedEmailDomains
        BEDROCK_AGENT_ROLE_ARN: !GetAtt BedrockAgentServiceRole.Arn
        BEDROCK_AGENT_ALIAS_ID: !Ref BedrockAgentAliasId
        BEDROCK_KB_ID: !Sub '{{resolve:ssm:/prechat/${Stage}/agents/bedrock-kb-id}}'
        # Strands Agent Runtime ARNs (SSM Parameter Store에서 resolve)
        CONSULTATION_AGENT_ARN: !Sub '{{resolve:ssm:/prechat/${Stage}/agents/consultation/runtime-arn}}'
        ANALYSIS_AGENT_ARN: !Sub '{{resolve:ssm:/prechat/${Stage}/agents/analysis/runtime-arn}}'
        PLANNING_AGENT_ARN: !Sub '{{resolve:ssm:/prechat/${Stage}/agents/planning/runtime-arn}}'
    KmsKeyArn: !GetAtt DynamoDBKMSKey.Arn
  Api:
    EndpointConfiguration: REGIONAL

Resources:
  # Security Resources
  # IAM Policies for Reusability
  S3ReplicationPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for S3 cross-region replication
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: S3ReplicationSource
            Effect: Allow
            Action:
              - s3:GetObjectVersionForReplication
              - s3:GetObjectVersionAcl
              - s3:GetObjectVersionTagging
            Resource: !Sub "arn:aws:s3:::${AWS::StackName}-website-${Stage}-${AWS::AccountId}/*"
          - Sid: S3ReplicationBucket
            Effect: Allow
            Action:
              - s3:GetReplicationConfiguration
              - s3:ListBucket
            Resource: !Sub "arn:aws:s3:::${AWS::StackName}-website-${Stage}-${AWS::AccountId}"
          - Sid: S3ReplicationDestination
            Effect: Allow
            Action:
              - s3:ReplicateObject
              - s3:ReplicateDelete
              - s3:ReplicateTags
            Resource: !Sub "arn:aws:s3:::${AWS::StackName}-failover-${Stage}-${AWS::AccountId}/*"

  # KMS Key for DynamoDB Tables Encryption
  DynamoDBKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS Key for DynamoDB tables encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow DynamoDB service to use the key
            Effect: Allow
            Principal:
              Service: dynamodb.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '*'
          - Sid: Allow Lambda execution roles to use the key
            Effect: Allow
            Principal:
              AWS: '*'
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '*'
            Condition:
              StringLike:
                "aws:PrincipalArn": 
                  - !Sub "arn:aws:iam::${AWS::AccountId}:role/${AWS::StackName}-*"
          - Sid: Allow CloudWatch Logs service to use the key
            Effect: Allow
            Principal:
              Service: logs.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '*'
            Condition:
              ArnEquals:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:*"
          - Sid: Allow SQS service to use the key
            Effect: Allow
            Principal:
              Service: sqs.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '*'
          - Sid: Allow SNS service to use the key
            Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Action:
              - kms:Decrypt
              - kms:DescribeKey
              - kms:Encrypt
              - kms:GenerateDataKey*
              - kms:ReEncrypt*
            Resource: '*'

  DynamoDBKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}-dynamodb-${Stage}'
      TargetKeyId: !Ref DynamoDBKMSKey

  # Dead Letter Queue for Lambda Functions
  LambdaDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${AWS::StackName}-lambda-dlq-${Stage}'
      MessageRetentionPeriod: 1209600  # 14 days
      KmsMasterKeyId: !Ref DynamoDBKMSKey

  # VPC Configuration
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc-${Stage}'



  # Private Subnets for Lambda Functions
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.11.0/24
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-1-${Stage}'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.12.0/24
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-2-${Stage}'



  # Route Tables
  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-routes-1-${Stage}'

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-routes-2-${Stage}'

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      SubnetId: !Ref PrivateSubnet2

  # Security Group for Lambda Functions
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationPrefixListId: pl-48a54021
          Description: HTTPS outbound to DynamoDB via Gateway VPC endpoint
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationPrefixListId: pl-78a54011
          Description: HTTPS outbound to S3 via Gateway VPC endpoint
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16
          Description: HTTP outbound within VPC for internal communication
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 10.0.0.0/16
          Description: HTTP outbound within VPC for internal communication
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-lambda-sg-${Stage}'

  # VPC Endpoints for AWS Services
  DynamoDBVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.dynamodb'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable1
        - !Ref PrivateRouteTable2

  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable1
        - !Ref PrivateRouteTable2

  # Interface VPC Endpoints for other AWS services
  BedrockVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.bedrock-runtime'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  BedrockAgentCoreVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.bedrock-agentcore'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  CognitoVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.cognito-idp'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  SQSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.sqs'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  KMSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.kms'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  SNSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.sns'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # API Gateway Management API용 VPC Endpoint
  # WebSocket Lambda가 VPC 내에서 post_to_connection 호출 시 필요
  ExecuteApiVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.execute-api'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # Security Group for VPC Endpoints
  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC endpoints
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: HTTPS from Lambda functions security group
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/16
          Description: Boilerplate egress rule for security check
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc-endpoint-sg-${Stage}'

  # AgentCore Agent Service Role
  BedrockAgentServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess

  AdminUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: mte-admin-users
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: false
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      EmailVerificationMessage: "[AWS PreChat] This is your sign-in code: \"{####}\""
      EmailVerificationSubject: "[AWS PreChat] Your sign-in code"
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
      Schema:
        - Name: email
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: name
          AttributeDataType: String
          Required: true
          Mutable: true
        - Name: phone_number
          AttributeDataType: String
          Required: true
          Mutable: true

  AdminUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref AdminUserPool
      ClientName: mte-admin-client
      GenerateSecret: false
      ExplicitAuthFlows:
        - ADMIN_NO_SRP_AUTH
        - USER_PASSWORD_AUTH
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 24
      IdTokenValidity: 24
      RefreshTokenValidity: 30

  # DynamoDB Tables
  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref DynamoDBKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-sessions-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Encryption
          Value: KMS

  MessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref DynamoDBKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-messages-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Encryption
          Value: KMS

  CampaignsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: campaignCode
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: CampaignCodeIndex
          KeySchema:
            - AttributeName: campaignCode
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !Ref DynamoDBKMSKey
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-campaigns-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Encryption
          Value: KMS

  # API Gateway
  ApiGateway:
    Type: AWS::Serverless::Api
    DependsOn: ApiGatewayAccount
    Properties:
      StageName: !Ref Stage
      TracingEnabled: true
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: '$context.identity.sourceIp $context.identity.caller $context.identity.user [$context.requestTime]"$context.httpMethod $context.resourcePath $context.protocol" $context.status $context.responseLength $context.requestId $context.extendedRequestId'
      CacheClusterEnabled: true
      CacheClusterSize: "0.5"
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          CachingEnabled: true
          CacheTtlInSeconds: 1
          LoggingLevel: INFO
          DataTraceEnabled: true
          MetricsEnabled: true
          ThrottlingRateLimit: 100
          ThrottlingBurstLimit: 200
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt AdminUserPool.Arn
      Tags:
        Name: !Sub '${AWS::StackName}-api-gateway'
        Environment: !Ref Stage
        Caching: Enabled
        Tracing: Enabled
        Logging: Enabled

  # ============================================
  # Shared Lambda Layer (공통 코드: utils, models, agent_runtime, trigger_manager)
  # ============================================
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub '${AWS::StackName}-shared-layer-${Stage}'
      Description: Shared utilities, models, agent_runtime, trigger_manager
      ContentUri: packages/backend/shared/
      CompatibleRuntimes:
        - python3.13
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.13

  # ============================================
  # Domain-Based Lambda Functions
  # ============================================

  # Session Messages - POST /api/sessions/{sessionId}/messages
  SessionMessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_messages_handler.send_message
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
      Events:
        SendMessage:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/messages
            Method: post

  # Session Messages Stream - POST /api/sessions/{sessionId}/messages/stream
  SessionMessagesStreamFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_messages_handler.send_message_stream
      Timeout: 300
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
      Events:
        SendMessageStream:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/messages/stream
            Method: post

  # Get Session - GET /api/sessions/{sessionId}
  GetSessionByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_handler.get_session
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:ListUsers
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        GetSessionById:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}
            Method: get

  # Verify PIN - POST /api/sessions/{sessionId}/verify-pin
  VerifySessionPinNewFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_handler.verify_session_pin
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        VerifyPin:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/verify-pin
            Method: post

  # Consultation Purposes - PUT /api/sessions/{sessionId}/consultation-purposes
  UpdateConsultationPurposesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: chat_handler.update_consultation_purposes
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        UpdatePurposes:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/consultation-purposes
            Method: put

  # Session Feedback - POST /api/sessions/{sessionId}/feedback
  SessionFeedbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: chat_handler.handle_feedback
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        SessionFeedback:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/feedback
            Method: post

  CreateSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_handler.create_session
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        CreateSession:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer


  # [REMOVED] Legacy VerifySessionPinFunction (/api/chat/session/{sessionId}/verify-pin)
  # Migrated to VerifySessionPinNewFunction at /api/sessions/{sessionId}/verify-pin

  GetCampaignByCodeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/session/
      Handler: session_handler.get_campaign_by_code
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaignByCode:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/campaigns/code/{campaignCode}
            Method: get



  # Cognito User Management Functions
  ListCognitoUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: cognito_handler.list_cognito_users
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:ListUsers
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        ListCognitoUsers:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/users
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetCognitoUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: cognito_handler.get_cognito_user
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:AdminGetUser
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        GetCognitoUser:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/users/{userId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer


  ListSessionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.list_sessions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        ListSessions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetSessionDetailsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.get_session_details
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetSessionDetails:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/details
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.get_session_report
      Timeout: 300
      MemorySize: 1024
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - bedrock:InvokeModel
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
      Events:
        GetReport:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/report
            Method: get
            TimeoutInMillis: 29000
            Auth:
              Authorizer: CognitoAuthorizer

  InactivateSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.patch_session
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        PatchSession:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}
            Method: patch
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteSessionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.delete_session
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
      Events:
        DeleteSession:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  SignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: auth_handler.signup
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:SignUp
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        Signup:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/auth/signup
            Method: post

  SigninFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: auth_handler.signin
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:AdminInitiateAuth
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        Signin:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/auth/signin
            Method: post


  ConfirmSignupFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: auth_handler.confirm_signup
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:ConfirmSignUp
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        ConfirmSignup:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/auth/confirm
            Method: post

  VerifyTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: auth_handler.verify_token
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:GetUser
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        VerifyToken:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/auth/verify
            Method: get

  ConfirmPhoneFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/auth/
      Handler: auth_handler.confirm_phone
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:VerifyUserAttribute
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        ConfirmPhone:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/auth/confirm-phone
            Method: post

  # [REMOVED] Bedrock Agent direct CRUD endpoints
  # Agent infrastructure is managed by system admin via deploy_agent.py
  # PreChat users manage agent configurations via /api/admin/agent-configs

  # ============================================
  # Trigger Management API (New)
  # ============================================

  CreateTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.create_trigger
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        CreateTrigger:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  ListTriggersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.list_triggers
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        ListTriggers:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.get_trigger
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        GetTrigger:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers/{triggerId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.update_trigger
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        UpdateTrigger:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers/{triggerId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.delete_trigger
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        DeleteTrigger:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers/{triggerId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  ListSnsTopicsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/trigger/
      Handler: trigger_api_handler.list_sns_topics
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - sns:ListTopics
            Resource: '*'
      Events:
        ListSnsTopics:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/triggers/sns-topics
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # ============================================
  # Meeting Plan API (New)
  # ============================================

  # ============================================
  # Agent Configuration API (New)
  # ============================================

  CreateAgentConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: agent_config_handler.create_config
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        CreateAgentConfig:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/agent-configs
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  ListAgentConfigsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: agent_config_handler.list_configs
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        ListAgentConfigs:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/agent-configs
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetAgentConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: agent_config_handler.get_config
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
      Events:
        GetAgentConfig:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/agent-configs/{configId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateAgentConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: agent_config_handler.update_config
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        UpdateAgentConfig:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/agent-configs/{configId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteAgentConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: agent_config_handler.delete_config
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        DeleteAgentConfig:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/agent-configs/{configId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  GenerateMeetingPlanFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/meeting/
      Handler: meeting_plan_handler.generate_meeting_plan
      Timeout: 120
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - bedrock:Retrieve
              - bedrock:InvokeModel
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
      Events:
        GenerateMeetingPlan:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/meeting-plan
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  GetMeetingPlanFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/meeting/
      Handler: meeting_plan_handler.get_meeting_plan
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
      Events:
        GetMeetingPlan:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/meeting-plan
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateMeetingPlanFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/meeting/
      Handler: meeting_plan_handler.update_meeting_plan
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        UpdateMeetingPlan:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/meeting-plan
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  AddMeetingPlanCommentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/meeting/
      Handler: meeting_plan_handler.add_comment
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        AddMeetingPlanComment:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/meeting-plan/comments
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  # SQS Queue for Analysis Jobs
  AnalysisQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: mte-analysis-queue
      VisibilityTimeout: 900
      MessageRetentionPeriod: 1209600
      KmsMasterKeyId: !Ref DynamoDBKMSKey

  # SNS Topic for Slack Notifications
  SlackNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${AWS::StackName}-slack-notification'
      DisplayName: 'PreChat Session Notifications'
      KmsMasterKeyId: !Ref DynamoDBKMSKey



  # Unified Analysis Function (analyze + reanalyze merged)
  RequestAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.submit_analysis
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - Statement:
            Effect: Allow
            Action:
              - dynamodb:Query
            Resource: !Sub "${SessionsTable.Arn}/index/GSI1"
        - Statement:
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt AnalysisQueue.Arn
      Environment:
        Variables:
          ANALYSIS_QUEUE_URL: !Ref AnalysisQueue
      Events:
        SubmitAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/analysis
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  # Consumer Function - Processes analysis from SQS via AgentCore
  ProcessAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.process_analysis
      Timeout: 900
      MemorySize: 1024
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - dynamodb:Query
            Resource: !Sub "${SessionsTable.Arn}/index/GSI1"
        - Statement:
            Effect: Allow
            Action:
              - bedrock:InvokeModel
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
      Events:
        ProcessAnalysis:
          Type: SQS
          Properties:
            Queue: !GetAtt AnalysisQueue.Arn
            BatchSize: 1

  # Status Function - Check analysis status
  GetAnalysisStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.get_analysis_status
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        GetAnalysisStatus:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/analysis-status
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # Meeting Log Functions
  SaveMeetingLogFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.save_meeting_log
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        SaveMeetingLog:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/meeting-log
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  # [REMOVED] ReanalyzeWithMeetingLogFunction - merged into POST /api/admin/sessions/{sessionId}/analysis
  # Client should include { includeMeetingLog: true } in the request body

  # Session Feedback Function
  GetSessionFeedbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_handler.get_session_feedback
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        GetSessionFeedback:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/feedback
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # Discussion Functions
  ListDiscussionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: discussion_handler.list_discussions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        ListDiscussions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/discussions
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  CreateDiscussionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: discussion_handler.create_discussion
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        CreateDiscussion:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/discussions
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateDiscussionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: discussion_handler.update_discussion
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        UpdateDiscussion:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/discussions/{discussionId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteDiscussionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: discussion_handler.delete_discussion
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        DeleteDiscussion:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/discussions/{discussionId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  # AWS Documentation Tools Action Group
  AWSDocsActionFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/agent/
      Handler: aws_docs_handler.aws_docs_action_handler
      MemorySize: 512
      Timeout: 30
      Events:
        BedrockActionApi:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /bedrock/aws-docs-action
            Method: post

  # [REMOVED] Legacy GenerateUploadUrlFunction (/api/chat/session/{sessionId}/upload-url)
  # File upload should use domain-based endpoint /api/sessions/{sessionId}/files/upload-url

  # [REMOVED] Legacy ListSessionFilesFunction (/api/chat/session/{sessionId}/files)
  # File listing should use domain-based endpoint /api/sessions/{sessionId}/files

  # [REMOVED] Legacy DeleteSessionFileFunction (/api/chat/session/{sessionId}/files/{fileKey+})
  # File deletion should use domain-based endpoint /api/sessions/{sessionId}/files/{fileKey+}

  # Customer-facing file operations (domain-based)
  GenerateUploadUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/file/
      Handler: file_upload_handler.generate_presigned_url
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - Statement:
            Effect: Allow
            Action:
              - s3:GetBucketLocation
            Resource: !GetAtt WebsiteBucket.Arn
        - Statement:
            Effect: Allow
            Action:
              - s3:PutObject
              - s3:PutObjectTagging
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        GenerateUploadUrl:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/files/upload-url
            Method: post

  ListSessionFilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/file/
      Handler: file_upload_handler.list_session_files
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - Statement:
            Effect: Allow
            Action:
              - s3:ListBucket
            Resource: !GetAtt WebsiteBucket.Arn
            Condition:
              StringLike:
                s3:prefix: "uploads/*"
        - Statement:
            Effect: Allow
            Action:
              - s3:HeadObject
              - s3:GetObject
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        ListSessionFiles:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/files
            Method: get

  DeleteSessionFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/file/
      Handler: file_upload_handler.delete_session_file
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - Statement:
            Effect: Allow
            Action:
              - s3:DeleteObject
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        DeleteSessionFile:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/sessions/{sessionId}/files/{fileKey+}
            Method: delete

  # [REMOVED] Legacy FeedbackFunction (/api/chat/session/{sessionId}/feedback)
  # Migrated to SessionFeedbackFunction at /api/sessions/{sessionId}/feedback

  # Campaign Management Functions
  CreateCampaignFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.create_campaign
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:AdminGetUser
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        CreateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  ListCampaignsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.list_campaigns
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        ListCampaigns:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetCampaignFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.get_campaign
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns/{campaignId}
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateCampaignFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.update_campaign
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:AdminGetUser
            Resource: !GetAtt AdminUserPool.Arn
      Events:
        UpdateCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns/{campaignId}
            Method: put
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteCampaignFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.delete_campaign
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        DeleteCampaign:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns/{campaignId}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  GetCampaignSessionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_handler.get_campaign_sessions
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaignSessions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns/{campaignId}/sessions
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # [REMOVED] AssociateSessionWithCampaignFunction - merged into PATCH /api/admin/sessions/{sessionId}
  # Client should include { campaignId: "..." } in the PATCH body

  # Campaign Analytics Functions
  GetCampaignAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_analytics.get_campaign_analytics
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaignAnalytics:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/campaigns/{campaignId}/analytics
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetCampaignsSummaryAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_analytics.get_campaigns_summary_analytics
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaignsSummaryAnalytics:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/analytics/summary
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  GetCampaignComparisonAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/campaign/
      Handler: campaign_analytics.get_campaign_comparison_analytics
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        GetCampaignComparisonAnalytics:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/analytics/comparison
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # [REMOVED] Legacy UpdateConsultationPurposesFunction (/api/chat/session/{sessionId}/purposes)
  # Migrated to domain-based endpoint at /api/sessions/{sessionId}/consultation-purposes

  # Migration Functions
  MigrateCampaignsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/migration/
      Handler: migration_handler.migrate_campaigns_handler
      Timeout: 900
      MemorySize: 512
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable
      Events:
        MigrateCampaigns:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/migrate/campaigns
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  FixCampaignSessionCountsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/migration/
      Handler: fix_campaign_session_counts.fix_campaign_session_counts
      Timeout: 900
      MemorySize: 512
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CampaignsTable

  VerifyMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/migration/
      Handler: migration_handler.verify_migration_handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
      Events:
        VerifyMigration:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/migrate/campaigns/verify
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  # Admin File Functions (no CSRF required)
  ListSessionFilesAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_file_handler.list_session_files_admin
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:ListBucket
            Resource: !GetAtt WebsiteBucket.Arn
            Condition:
              StringLike:
                s3:prefix: "uploads/*"
        - Statement:
            Effect: Allow
            Action:
              - s3:HeadObject
              - s3:GetObject
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        ListSessionFilesAdmin:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/files
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteSessionFileAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_file_handler.delete_session_file_admin
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:DeleteObject
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        DeleteSessionFileAdmin:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/files/{fileKey+}
            Method: delete
            Auth:
              Authorizer: CognitoAuthorizer

  GenerateFilePresignedUrlFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: admin_file_handler.generate_file_presigned_url
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:HeadObject
              - s3:GetObject
            Resource: !Sub "${WebsiteBucket.Arn}/uploads/*"
      Events:
        GenerateFilePresignedUrl:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/sessions/{sessionId}/files/presigned-url/{fileKey+}
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  # Customization Functions
  CustomizationGetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: customization_handler.get_customization
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:GetObject
            Resource: !Sub "${WebsiteBucket.Arn}/customization/*"
      Events:
        GetCustomization:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/customization
            Method: get
            Auth:
              Authorizer: CognitoAuthorizer

  CustomizationSaveFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: customization_handler.save_customization
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: !Sub "${WebsiteBucket.Arn}/customization/*"
      Events:
        SaveCustomization:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/customization
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  CustomizationUploadLogoFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: customization_handler.upload_logo
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: !Sub "${WebsiteBucket.Arn}/customization/logos/*"
      Events:
        UploadLogo:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/customization/upload/logo
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  CustomizationUploadLegalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/admin/
      Handler: customization_handler.upload_legal_doc
      Environment:
        Variables:
          WEBSITE_BUCKET: !Ref WebsiteBucket
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - s3:PutObject
            Resource: !Sub "${WebsiteBucket.Arn}/customization/legal/*"
      Events:
        UploadLegalDoc:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /api/admin/customization/upload/legal/{docType}
            Method: post
            Auth:
              Authorizer: CognitoAuthorizer

  # DynamoDB Streams Handler
  # NOTE: VPC 밖에 배치 - Slack Webhook 등 외부 아웃바운드 호출을 위해 퍼블릭 네트워크 필요 (NAT 미사용)
  SessionStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/stream/
      Handler: stream_handler.handle_session_stream
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - sqs:SendMessage
            Resource: !GetAtt AnalysisQueue.Arn
        - Statement:
            Effect: Allow
            Action:
              - s3:ListBucket
              - s3:DeleteObject
            Resource: 
              - !GetAtt WebsiteBucket.Arn
              - !Sub "${WebsiteBucket.Arn}/uploads/*"
        - Statement:
            Effect: Allow
            Action:
              - sns:Publish
            Resource: !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:*"
      Environment:
        Variables:
          ANALYSIS_QUEUE_URL: !Ref AnalysisQueue
          WEBSITE_BUCKET: !Ref WebsiteBucket
          CLOUDFRONT_URL: !Sub "https://${CloudFrontDistribution.DomainName}"
      Events:
        SessionStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt SessionsTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5

  # DynamoDB Streams Handler for Campaign lifecycle events
  # NOTE: VPC 밖에 배치 - Slack Webhook 등 외부 아웃바운드 호출을 위해 퍼블릭 네트워크 필요 (NAT 미사용)
  CampaignStreamHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/stream/
      Handler: stream_handler.handle_campaign_stream
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref CampaignsTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - Statement:
            Effect: Allow
            Action:
              - sns:Publish
            Resource: !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:*"
      Events:
        CampaignStream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt CampaignsTable.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5

  # CloudWatch Log Group for S3 Bucket Notifications
  S3WebsiteBucketLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/s3/${AWS::StackName}-website-bucket"
      RetentionInDays: 30
      KmsKeyId: !GetAtt DynamoDBKMSKey.Arn

  # CloudWatch Log Group for API Gateway Access Logs
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/apigateway/${AWS::StackName}-api-access-logs"
      RetentionInDays: 30
      KmsKeyId: !GetAtt DynamoDBKMSKey.Arn

  # IAM Role for API Gateway CloudWatch Logging
  ApiGatewayCloudWatchRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs

  # API Gateway Account Configuration for CloudWatch Logging
  ApiGatewayAccount:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn: !GetAtt ApiGatewayCloudWatchRole.Arn

  # S3 Access Logging Bucket
  AccessLoggingBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-access-logs-${Stage}-${AWS::AccountId}"
      ObjectLockEnabled: false
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-access-logs-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Purpose
          Value: AccessLogging
    Metadata:
      guard:
        SuppressedRules:
          - S3_BUCKET_DEFAULT_LOCK_ENABLED
          - S3_BUCKET_LOGGING_ENABLED
          - S3_BUCKET_NO_PUBLIC_RW_ACL
          - S3_BUCKET_REPLICATION_ENABLED

  # Bucket Policy for S3 Server Access Logs
  AccessLoggingBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLoggingBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt AccessLoggingBucket.Arn
              - !Sub "${AccessLoggingBucket.Arn}/*"
            Condition:
              Bool:
                "aws:SecureTransport": false
          - Sid: S3ServerAccessLogsPolicy
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action:
              - s3:PutObject
            Resource: !Sub "${AccessLoggingBucket.Arn}/${AWS::StackName}/*"
            Condition:
              ArnLike:
                "aws:SourceArn": !GetAtt WebsiteBucket.Arn
              StringEquals:
                "aws:SourceAccount": !Ref AWS::AccountId
          - Sid: S3ServerAccessLogsDelivery
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action:
              - s3:GetBucketAcl
            Resource: !GetAtt AccessLoggingBucket.Arn
            Condition:
              StringEquals:
                "aws:SourceAccount": !Ref AWS::AccountId

  # Bucket Policy for Failover Bucket TLS Enforcement
  FailoverBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FailoverBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt FailoverBucket.Arn
              - !Sub "${FailoverBucket.Arn}/*"
            Condition:
              Bool:
                "aws:SecureTransport": false
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            NotResource: !Sub "${WebsiteBucket.Arn}/uploads/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 
                  - "arn:aws:cloudfront::${AccountId}:distribution/${DistributionId}"
                  - AccountId: !Ref AWS::AccountId
                    DistributionId: !Ref CloudFrontDistribution

  # S3 Failover/Replication Bucket (Different Region)
  FailoverBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-failover-${Stage}-${AWS::AccountId}"
      ObjectLockEnabled: false
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-failover-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Purpose
          Value: Failover
    Metadata:
      guard:
        SuppressedRules:
          - S3_BUCKET_DEFAULT_LOCK_ENABLED
          - S3_BUCKET_LOGGING_ENABLED
          - S3_BUCKET_NO_PUBLIC_RW_ACL
          - S3_BUCKET_REPLICATION_ENABLED

  # IAM Role for S3 Replication
  S3ReplicationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref S3ReplicationPolicy

  # S3 Bucket for Static Website (Enhanced Security)
  WebsiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-website-${Stage}-${AWS::AccountId}"
      ObjectLockEnabled: false
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLoggingBucket
        LogFilePrefix: !Sub "${AWS::StackName}/"
      ReplicationConfiguration:
        Role: !GetAtt S3ReplicationRole.Arn
        Rules:
          - Id: ReplicateToFailover
            Status: Enabled
            Destination:
              Bucket: !Sub "arn:aws:s3:::${FailoverBucket}"
              StorageClass: ONEZONE_IA
      CorsConfiguration:
        CorsRules:
          - Id: FileUploadCorsRule
            AllowedHeaders:
              - "*"
            AllowedMethods:
              - PUT
              - POST
              - GET
              - HEAD
              - DELETE
            AllowedOrigins:
              - "*"
            ExposedHeaders:
              - ETag
              - x-amz-meta-original-filename-encoded
              - x-amz-version-id
            MaxAge: 3600
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-website-${Stage}'
        - Key: Environment
          Value: !Ref Stage
        - Key: Encryption
          Value: SSE-S3
        - Key: Versioning
          Value: Enabled
        - Key: Replication
          Value: Enabled
    Metadata:
      guard:
        SuppressedRules:
          - S3_BUCKET_DEFAULT_LOCK_ENABLED
          - S3_BUCKET_NO_PUBLIC_RW_ACL
        
  # CloudFront Origin Access Control
  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${AWS::StackName}-oac-${Stage}"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # S3 Bucket Policy for CloudFront OAC and TLS Enforcement
  WebsiteBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref WebsiteBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !GetAtt WebsiteBucket.Arn
              - !Sub "${WebsiteBucket.Arn}/*"
            Condition:
              Bool:
                "aws:SecureTransport": false
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            NotResource: !Sub "${WebsiteBucket.Arn}/uploads/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 
                  - "arn:aws:cloudfront::${AccountId}:distribution/${DistributionId}"
                  - AccountId: !Ref AWS::AccountId
                    DistributionId: !Ref CloudFrontDistribution

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt WebsiteBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !Ref OriginAccessControl
          - Id: S3FailoverOrigin
            DomainName: !GetAtt FailoverBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !Ref OriginAccessControl
        OriginGroups:
          Quantity: 1
          Items:
            - Id: S3OriginGroup
              FailoverCriteria:
                StatusCodes:
                  Quantity: 3
                  Items:
                    - 403
                    - 404
                    - 500
              Members:
                Quantity: 2
                Items:
                  - OriginId: S3Origin
                  - OriginId: S3FailoverOrigin
        DefaultRootObject: index.html
        DefaultCacheBehavior:
          TargetOriginId: S3OriginGroup
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6  # Managed-CachingOptimized
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        PriceClass: PriceClass_100
        Comment: !Sub "PreChat Website - ${Stage}"
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
          MinimumProtocolVersion: TLSv1.2_2021
        HttpVersion: http2and3
    Metadata:
      guard:
        SuppressedRules:
          - CLOUDFRONT_ACCESSLOGS_ENABLED
          - CLOUDFRONT_CUSTOM_SSL_CERTIFICATE
          - CLOUDFRONT_MINIMUM_PROTOCOL_VERSION_RULE
          - CLOUDFRONT_SNI_ENABLED

  # ============================================
  # WebSocket Lambda 함수
  # ============================================

  # ============================================
  # WebSocket Lambda 함수
  # VPC 밖에서 실행: execute-api VPC Endpoint(PrivateDnsEnabled=true)가
  # public WebSocket API의 @connections Management API 호출을 403으로 차단하므로
  # WebSocket 함수들은 VPC 밖에서 퍼블릭 엔드포인트로 통신해야 합니다.
  # ref: https://repost.aws/knowledge-center/api-gateway-vpc-connections
  # ============================================

  # WebSocket $connect 핸들러 - 세션 검증 및 연결 수립
  WebSocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/websocket/
      Handler: websocket_handler.handle_connect
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable

  # WebSocket $disconnect 핸들러 - 연결 정리
  WebSocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/websocket/
      Handler: websocket_handler.handle_disconnect
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable

  # WebSocket sendMessage 핸들러 - 메시지 처리 및 AgentCore 스트리밍
  WebSocketSendMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/websocket/
      Handler: websocket_handler.handle_send_message
      Timeout: 300
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref MessagesTable
        - Statement:
            Effect: Allow
            Action:
              - bedrock-agentcore:InvokeAgentRuntime
            Resource: '*'
        - Statement:
            Effect: Allow
            Action:
              - execute-api:ManageConnections
            Resource: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/${Stage}/POST/@connections/*'

  # WebSocket $default 핸들러 - 알 수 없는 액션 처리
  WebSocketDefaultFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: packages/backend/websocket/
      Handler: websocket_handler.handle_default
      VpcConfig: !Ref AWS::NoValue
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - execute-api:ManageConnections
            Resource: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/${Stage}/POST/@connections/*'

  # WebSocket Lambda Permission - API Gateway가 각 함수를 호출할 수 있도록 허용
  WebSocketConnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketConnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$connect'

  WebSocketDisconnectPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDisconnectFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$disconnect'

  WebSocketSendMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketSendMessageFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/sendMessage'

  WebSocketDefaultPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref WebSocketDefaultFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketApi}/*/$default'

  # ============================================
  # WebSocket API Gateway (실시간 스트리밍)
  # ============================================

  # WebSocket API 정의
  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub '${AWS::StackName}-websocket-${Stage}'
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: $request.body.action
      Tags:
        Name: !Sub '${AWS::StackName}-websocket-api'
        Environment: !Ref Stage

  # WebSocket 스테이지 (자동 배포)
  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref WebSocketApi
      StageName: !Ref Stage
      AutoDeploy: true
      Tags:
        Name: !Sub '${AWS::StackName}-websocket-stage-${Stage}'
        Environment: !Ref Stage

  # ---- $connect 라우트 ----
  WebSocketConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketConnectFunction.Arn}/invocations'

  WebSocketConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Sub 'integrations/${WebSocketConnectIntegration}'

  # ---- $disconnect 라우트 ----
  WebSocketDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDisconnectFunction.Arn}/invocations'

  WebSocketDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Sub 'integrations/${WebSocketDisconnectIntegration}'

  # ---- sendMessage 라우트 ----
  WebSocketSendMessageIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketSendMessageFunction.Arn}/invocations'

  WebSocketSendMessageRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: sendMessage
      AuthorizationType: NONE
      Target: !Sub 'integrations/${WebSocketSendMessageIntegration}'

  # ---- $default 라우트 ----
  WebSocketDefaultIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketDefaultFunction.Arn}/invocations'

  WebSocketDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $default
      AuthorizationType: NONE
      Target: !Sub 'integrations/${WebSocketDefaultIntegration}'

Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
  ApiGatewayLogGroup:
    Description: API Gateway CloudWatch Log Group
    Value: !Ref ApiGatewayLogGroup
  BedrockActionEndpoint:
    Description: AgentCore Agent Action Group endpoint URL
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/bedrock/aws-docs-action"
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref AdminUserPool
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref AdminUserPoolClient
  AnalysisQueueUrl:
    Description: SQS Queue URL for analysis jobs
    Value: !Ref AnalysisQueue
  SlackNotificationTopicArn:
    Description: SNS Topic ARN for Slack notifications
    Value: !Ref SlackNotificationTopic
  Stage:
    Description: Deployment stage
    Value: !Ref Stage
  WebsiteBucket:
    Description: S3 Bucket for static website
    Value: !Ref WebsiteBucket
  AccessLoggingBucket:
    Description: S3 Bucket for access logging
    Value: !Ref AccessLoggingBucket
  FailoverBucket:
    Description: S3 Bucket for failover/replication
    Value: !Ref FailoverBucket
  WebsiteURL:
    Description: Website URL
    Value: !Sub "https://${CloudFrontDistribution.DomainName}"
  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Value: !Ref CloudFrontDistribution
  VPCId:
    Description: VPC ID for Lambda functions
    Value: !Ref VPC
  DynamoDBKMSKeyId:
    Description: Primary KMS Key ID for DynamoDB and Lambda encryption
    Value: !Ref DynamoDBKMSKey
  DynamoDBKMSKeyArn:
    Description: Primary KMS Key ARN for DynamoDB and Lambda encryption
    Value: !GetAtt DynamoDBKMSKey.Arn
  S3ReplicationPolicyArn:
    Description: Reusable IAM policy for S3 cross-region replication
    Value: !Ref S3ReplicationPolicy
  LambdaDeadLetterQueueUrl:
    Description: Dead Letter Queue URL for Lambda functions
    Value: !Ref LambdaDeadLetterQueue
  CampaignsTable:
    Description: DynamoDB table for campaigns
    Value: !Ref CampaignsTable
  WebSocketUrl:
    Description: WebSocket API Gateway URL
    Value: !Sub "wss://${WebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"
  WebSocketApiId:
    Description: WebSocket API Gateway ID
    Value: !Ref WebSocketApi
